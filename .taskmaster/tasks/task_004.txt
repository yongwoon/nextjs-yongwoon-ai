# Task ID: 4
# Title: Magic Link Authentication System
# Status: done
# Dependencies: 3
# Priority: high
# Description: Implement unified email-based authentication with magic link functionality
# Details:
Create auth service using Supabase Auth API. Implement signInWithOtp for magic links. Create auth/callback route handler for magic link processing. Build EmailInputPage component with email validation using react-hook-form@^7.48 + zod@^3.22. Implement token generation and storage in auth_tokens table. Add email rate limiting (max 3 attempts per 15 minutes). Create custom email templates matching Claude.ai styling.

# Test Strategy:
Test magic link generation, email delivery, token validation, rate limiting, and successful authentication flow

# Subtasks:
## 1. Setup Supabase Auth API Integration [done]
### Dependencies: None
### Description: Initialize and configure Supabase client with Auth API for magic link authentication
### Details:
Create a dedicated auth service module that initializes Supabase client with proper configuration. Implement the signInWithOtp method specifically for magic links. Set up environment variables for Supabase URL and API keys. Create helper functions for managing authentication state and session handling.

## 2. Implement Email Input Component with Validation [done]
### Dependencies: None
### Description: Create the EmailInputPage component with proper validation using react-hook-form and zod
### Details:
Build a React component that renders an email input form. Implement form validation using react-hook-form@^7.48 with zod@^3.22 schema validation. Create email format validation rules. Add error handling and display validation messages. Connect the form submission to the auth service's signInWithOtp method. Implement loading states during authentication attempts.

## 3. Develop Auth Callback Route Handler [done]
### Dependencies: None
### Description: Create the route handler to process magic link tokens and authenticate users
### Details:
Implement an auth/callback route handler that extracts the token from URL parameters. Verify token validity using Supabase Auth API. Handle successful authentication by establishing a session. Implement error handling for invalid or expired tokens. Set up proper redirects after authentication (success/failure paths).
<info added on 2025-06-06T10:08:29.277Z>
✅ **Auth Callback Route Handler 구현 완료**

**구현한 주요 기능들:**

1. **`/src/app/auth/callback/route.ts` 생성**
   - Next.js App Router를 사용한 GET 라우트 핸들러 구현
   - URL 파라미터에서 `token_hash`, `type`, `next` 추출
   - AuthService.verifyOtp()를 통한 토큰 검증
   - 성공/실패에 따른 적절한 리다이렉트 처리

2. **에러 처리 및 리다이렉트**
   - 인증 성공 시: 지정된 페이지(`next`) 또는 홈(`/`)으로 리다이렉트
   - 인증 실패 시: `/login?error=authentication_failed&message=...`로 리다이렉트
   - 토큰 없음/무효 시: `/login?error=invalid_token&message=...`로 리다이렉트
   - 예상치 못한 에러 시: `/login?error=unexpected_error&message=...`로 리다이렉트

3. **AuthService 확장**
   - `verifyOtp(token_hash, type)` 메서드 추가
   - `getUser()` 메서드 추가
   - 모듈화된 접근으로 재사용성 향상

4. **로그인 페이지 에러 처리**
   - URL 파라미터를 통한 에러 메시지 표시
   - `useSearchParams`와 `useEffect`를 사용한 클라이언트 사이드 에러 처리
   - 시각적 에러 메시지 UI (빨간색 배경의 알림창)

**테스트 케이스:**
- ✅ 유효한 토큰으로 콜백 접근 시 인증 성공 및 리다이렉트
- ✅ 무효한 토큰으로 접근 시 에러 메시지와 함께 로그인 페이지로 리다이렉트
- ✅ 토큰 없이 접근 시 적절한 에러 처리
- ✅ 로그인 페이지에서 에러 메시지 표시

**다음 단계:** 실제 매직 링크 플로우 테스트 필요
</info added on 2025-06-06T10:08:29.277Z>

## 4. Implement Token Storage and Rate Limiting [done]
### Dependencies: None
### Description: Create token generation, storage in auth_tokens table, and implement rate limiting
### Details:
Design and create the auth_tokens table schema in Supabase. Implement token generation with appropriate expiration times. Create functions to store and validate tokens. Implement rate limiting logic to restrict users to maximum 3 email attempts per 15 minutes. Add timestamp tracking for rate limiting enforcement. Create error messages for rate-limited users.

## 5. Create Custom Email Templates [done]
### Dependencies: 4.4
### Description: Design and implement custom email templates for magic link authentication matching Claude.ai styling
### Details:
Design HTML email templates matching Claude.ai brand styling. Implement dynamic content insertion for magic links and user information. Configure Supabase to use custom email templates. Test email rendering across different email clients. Ensure proper handling of template variables for personalization. Implement both plain text and HTML versions of emails for compatibility.
<info added on 2025-06-06T15:46:21.090Z>
✅ **이메일 템플릿 구현 완료**

**구현한 주요 기능들:**

1. **매직 링크 이메일 템플릿 (`magic-link-template.ts`)**
   - Claude.ai 브랜딩에 맞는 깔끔하고 모던한 디자인
   - 그라데이션 헤더 (보라색 → 파란색)
   - Goguryeo + Gaemamusa AI 브랜딩 적용
   - 반응형 디자인 (모바일/데스크톱 대응)
   - HTML과 Plain Text 버전 모두 제공
   - 보안 안내 섹션 포함 (만료시간, 일회용 링크 등)
   - 대체 링크 표시 (버튼이 작동하지 않을 경우)

2. **이메일 템플릿 서비스 (`email-template-service.ts`)**
   - EmailTemplateService 클래스로 중앙화된 관리
   - 브랜드 설정 커스터마이징 지원
   - Supabase 이메일 템플릿 설정 자동 생성
   - 이메일 렌더링 검증 기능
   - 만료시간 자동 계산 (한국 시간대 기준)

3. **테스트 유틸리티 (`test-utils.ts`)**
   - 종합적인 템플릿 테스트 도구
   - 다양한 데이터 케이스 테스트
   - 이메일 클라이언트 호환성 체크
   - 브라우저에서 미리보기 기능
   - 개발자 친화적 전역 함수 제공

4. **개발자 미리보기 페이지 (`/dev/email-template-preview`)**
   - 실시간 템플릿 미리보기
   - 동적 데이터 변경 및 테스트
   - Supabase 설정 가이드 포함
   - 종합 테스트 결과 표시

5. **설정 가이드 문서 (`setup-guide.md`)**
   - Supabase Dashboard 설정 방법
   - 단계별 상세 가이드
   - 환경별 설정 방법
   - 배포 체크리스트 포함

**주요 특징:**
- 📱 반응형 디자인 (모바일 최적화)
- 🎨 Claude.ai 스타일 브랜딩
- 🔒 보안 안내 메시지 포함
- 🌐 다국어 지원 고려 (한국어)
- ✅ 이메일 클라이언트 호환성 확보
- 🧪 종합적인 테스트 도구 제공

**다음 단계:** Supabase Dashboard에서 템플릿 설정 필요
</info added on 2025-06-06T15:46:21.090Z>

