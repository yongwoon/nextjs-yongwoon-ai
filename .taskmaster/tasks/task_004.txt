# Task ID: 4
# Title: Magic Link Authentication System
# Status: done
# Dependencies: 3
# Priority: high
# Description: Implement unified email-based authentication with magic link functionality
# Details:
Create auth service using Supabase Auth API. Implement signInWithOtp for magic links. Create auth/callback route handler for magic link processing. Build EmailInputPage component with email validation using react-hook-form@^7.48 + zod@^3.22. Implement token generation and storage in auth_tokens table. Add email rate limiting (max 3 attempts per 15 minutes). Create custom email templates matching Claude.ai styling.

# Test Strategy:
Test magic link generation, email delivery, token validation, rate limiting, and successful authentication flow

# Subtasks:
## 1. Setup Supabase Auth API Integration [done]
### Dependencies: None
### Description: Initialize and configure Supabase client with Auth API for magic link authentication
### Details:
Create a dedicated auth service module that initializes Supabase client with proper configuration. Implement the signInWithOtp method specifically for magic links. Set up environment variables for Supabase URL and API keys. Create helper functions for managing authentication state and session handling.

## 2. Implement Email Input Component with Validation [done]
### Dependencies: None
### Description: Create the EmailInputPage component with proper validation using react-hook-form and zod
### Details:
Build a React component that renders an email input form. Implement form validation using react-hook-form@^7.48 with zod@^3.22 schema validation. Create email format validation rules. Add error handling and display validation messages. Connect the form submission to the auth service's signInWithOtp method. Implement loading states during authentication attempts.

## 3. Develop Auth Callback Route Handler [done]
### Dependencies: None
### Description: Create the route handler to process magic link tokens and authenticate users
### Details:
Implement an auth/callback route handler that extracts the token from URL parameters. Verify token validity using Supabase Auth API. Handle successful authentication by establishing a session. Implement error handling for invalid or expired tokens. Set up proper redirects after authentication (success/failure paths).
<info added on 2025-06-06T10:08:29.277Z>
âœ… **Auth Callback Route Handler êµ¬í˜„ ì™„ë£Œ**

**êµ¬í˜„í•œ ì£¼ìš” ê¸°ëŠ¥ë“¤:**

1. **`/src/app/auth/callback/route.ts` ìƒì„±**
   - Next.js App Routerë¥¼ ì‚¬ìš©í•œ GET ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ êµ¬í˜„
   - URL íŒŒë¼ë¯¸í„°ì—ì„œ `token_hash`, `type`, `next` ì¶”ì¶œ
   - AuthService.verifyOtp()ë¥¼ í†µí•œ í† í° ê²€ì¦
   - ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¥¸ ì ì ˆí•œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬

2. **ì—ëŸ¬ ì²˜ë¦¬ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸**
   - ì¸ì¦ ì„±ê³µ ì‹œ: ì§€ì •ëœ í˜ì´ì§€(`next`) ë˜ëŠ” í™ˆ(`/`)ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
   - ì¸ì¦ ì‹¤íŒ¨ ì‹œ: `/login?error=authentication_failed&message=...`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
   - í† í° ì—†ìŒ/ë¬´íš¨ ì‹œ: `/login?error=invalid_token&message=...`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
   - ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ ì‹œ: `/login?error=unexpected_error&message=...`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

3. **AuthService í™•ì¥**
   - `verifyOtp(token_hash, type)` ë©”ì„œë“œ ì¶”ê°€
   - `getUser()` ë©”ì„œë“œ ì¶”ê°€
   - ëª¨ë“ˆí™”ëœ ì ‘ê·¼ìœ¼ë¡œ ì¬ì‚¬ìš©ì„± í–¥ìƒ

4. **ë¡œê·¸ì¸ í˜ì´ì§€ ì—ëŸ¬ ì²˜ë¦¬**
   - URL íŒŒë¼ë¯¸í„°ë¥¼ í†µí•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
   - `useSearchParams`ì™€ `useEffect`ë¥¼ ì‚¬ìš©í•œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì—ëŸ¬ ì²˜ë¦¬
   - ì‹œê°ì  ì—ëŸ¬ ë©”ì‹œì§€ UI (ë¹¨ê°„ìƒ‰ ë°°ê²½ì˜ ì•Œë¦¼ì°½)

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:**
- âœ… ìœ íš¨í•œ í† í°ìœ¼ë¡œ ì½œë°± ì ‘ê·¼ ì‹œ ì¸ì¦ ì„±ê³µ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
- âœ… ë¬´íš¨í•œ í† í°ìœ¼ë¡œ ì ‘ê·¼ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ì™€ í•¨ê»˜ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- âœ… í† í° ì—†ì´ ì ‘ê·¼ ì‹œ ì ì ˆí•œ ì—ëŸ¬ ì²˜ë¦¬
- âœ… ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

**ë‹¤ìŒ ë‹¨ê³„:** ì‹¤ì œ ë§¤ì§ ë§í¬ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ í•„ìš”
</info added on 2025-06-06T10:08:29.277Z>

## 4. Implement Token Storage and Rate Limiting [done]
### Dependencies: None
### Description: Create token generation, storage in auth_tokens table, and implement rate limiting
### Details:
Design and create the auth_tokens table schema in Supabase. Implement token generation with appropriate expiration times. Create functions to store and validate tokens. Implement rate limiting logic to restrict users to maximum 3 email attempts per 15 minutes. Add timestamp tracking for rate limiting enforcement. Create error messages for rate-limited users.

## 5. Create Custom Email Templates [done]
### Dependencies: 4.4
### Description: Design and implement custom email templates for magic link authentication matching Claude.ai styling
### Details:
Design HTML email templates matching Claude.ai brand styling. Implement dynamic content insertion for magic links and user information. Configure Supabase to use custom email templates. Test email rendering across different email clients. Ensure proper handling of template variables for personalization. Implement both plain text and HTML versions of emails for compatibility.
<info added on 2025-06-06T15:46:21.090Z>
âœ… **ì´ë©”ì¼ í…œí”Œë¦¿ êµ¬í˜„ ì™„ë£Œ**

**êµ¬í˜„í•œ ì£¼ìš” ê¸°ëŠ¥ë“¤:**

1. **ë§¤ì§ ë§í¬ ì´ë©”ì¼ í…œí”Œë¦¿ (`magic-link-template.ts`)**
   - Claude.ai ë¸Œëœë”©ì— ë§ëŠ” ê¹”ë”í•˜ê³  ëª¨ë˜í•œ ë””ìì¸
   - ê·¸ë¼ë°ì´ì…˜ í—¤ë” (ë³´ë¼ìƒ‰ â†’ íŒŒë€ìƒ‰)
   - Goguryeo + Gaemamusa AI ë¸Œëœë”© ì ìš©
   - ë°˜ì‘í˜• ë””ìì¸ (ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ëŒ€ì‘)
   - HTMLê³¼ Plain Text ë²„ì „ ëª¨ë‘ ì œê³µ
   - ë³´ì•ˆ ì•ˆë‚´ ì„¹ì…˜ í¬í•¨ (ë§Œë£Œì‹œê°„, ì¼íšŒìš© ë§í¬ ë“±)
   - ëŒ€ì²´ ë§í¬ í‘œì‹œ (ë²„íŠ¼ì´ ì‘ë™í•˜ì§€ ì•Šì„ ê²½ìš°)

2. **ì´ë©”ì¼ í…œí”Œë¦¿ ì„œë¹„ìŠ¤ (`email-template-service.ts`)**
   - EmailTemplateService í´ë˜ìŠ¤ë¡œ ì¤‘ì•™í™”ëœ ê´€ë¦¬
   - ë¸Œëœë“œ ì„¤ì • ì»¤ìŠ¤í„°ë§ˆì´ì§• ì§€ì›
   - Supabase ì´ë©”ì¼ í…œí”Œë¦¿ ì„¤ì • ìë™ ìƒì„±
   - ì´ë©”ì¼ ë Œë”ë§ ê²€ì¦ ê¸°ëŠ¥
   - ë§Œë£Œì‹œê°„ ìë™ ê³„ì‚° (í•œêµ­ ì‹œê°„ëŒ€ ê¸°ì¤€)

3. **í…ŒìŠ¤íŠ¸ ìœ í‹¸ë¦¬í‹° (`test-utils.ts`)**
   - ì¢…í•©ì ì¸ í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸ ë„êµ¬
   - ë‹¤ì–‘í•œ ë°ì´í„° ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
   - ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„± ì²´í¬
   - ë¸Œë¼ìš°ì €ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
   - ê°œë°œì ì¹œí™”ì  ì „ì—­ í•¨ìˆ˜ ì œê³µ

4. **ê°œë°œì ë¯¸ë¦¬ë³´ê¸° í˜ì´ì§€ (`/dev/email-template-preview`)**
   - ì‹¤ì‹œê°„ í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸°
   - ë™ì  ë°ì´í„° ë³€ê²½ ë° í…ŒìŠ¤íŠ¸
   - Supabase ì„¤ì • ê°€ì´ë“œ í¬í•¨
   - ì¢…í•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ

5. **ì„¤ì • ê°€ì´ë“œ ë¬¸ì„œ (`setup-guide.md`)**
   - Supabase Dashboard ì„¤ì • ë°©ë²•
   - ë‹¨ê³„ë³„ ìƒì„¸ ê°€ì´ë“œ
   - í™˜ê²½ë³„ ì„¤ì • ë°©ë²•
   - ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ í¬í•¨

**ì£¼ìš” íŠ¹ì§•:**
- ğŸ“± ë°˜ì‘í˜• ë””ìì¸ (ëª¨ë°”ì¼ ìµœì í™”)
- ğŸ¨ Claude.ai ìŠ¤íƒ€ì¼ ë¸Œëœë”©
- ğŸ”’ ë³´ì•ˆ ì•ˆë‚´ ë©”ì‹œì§€ í¬í•¨
- ğŸŒ ë‹¤êµ­ì–´ ì§€ì› ê³ ë ¤ (í•œêµ­ì–´)
- âœ… ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„± í™•ë³´
- ğŸ§ª ì¢…í•©ì ì¸ í…ŒìŠ¤íŠ¸ ë„êµ¬ ì œê³µ

**ë‹¤ìŒ ë‹¨ê³„:** Supabase Dashboardì—ì„œ í…œí”Œë¦¿ ì„¤ì • í•„ìš”
</info added on 2025-06-06T15:46:21.090Z>

